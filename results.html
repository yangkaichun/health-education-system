<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>å•å·çµæœåˆ—è¡¨</title>
    <!-- ç¢ºä¿ CSS è·¯å¾‘æ­£ç¢ºä¸”æŒ‰æ­£ç¢ºé †åºè¼‰å…¥ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/results.css">
    <!-- é åŠ è¼‰é—œéµè³‡æº -->
    <link rel="preload" href="js/github-auth.js" as="script">
    <link rel="preload" href="js/github-storage.js" as="script">
</head>
<body>
    <!-- é é¢åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="page-loader" class="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <header>
        <h1>è¡›æ•™å½±ç‰‡è§€çœ‹ç³»çµ±</h1>
        <nav>
            <ul>
                <li><a href="index.html">å½±ç‰‡è§€çœ‹</a></li>
                <li><a href="results.html" class="active">çµæœåˆ—è¡¨</a></li>
                <li><a href="admin.html">ç®¡ç†è¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- ç³»çµ±è¨Šæ¯å€åŸŸ -->
        <div id="system-messages" class="system-messages">
            <!-- éŒ¯èª¤å’Œç‹€æ…‹æ¶ˆæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <section id="results-section">
            <div class="results-header">
                <h2>å•å·çµæœåˆ—è¡¨</h2>
                <button id="email-settings-button">è¨­å®šé€šçŸ¥ Email</button>
            </div>
            
            <div id="refresh-info">
                <span>é é¢å°‡æ¯ <strong id="refresh-seconds">30</strong> ç§’è‡ªå‹•åˆ·æ–°</span>
                <span id="countdown">30</span>
                <button id="manual-refresh">ç«‹å³åˆ·æ–°</button>
            </div>

            <div class="results-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>QR Code ä»£ç¢¼</th>
                            <th>è¡›æ•™ä¸»é¡Œ</th>
                            <th>å½±ç‰‡è§€çœ‹ç‹€æ…‹</th>
                            <th>å•å·åˆ†æ•¸</th>
                            <th>è­·ç†å¸«å·²çŸ¥æ›‰</th>
                            <th>è§€çœ‹æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                        <tr>
                            <td colspan="7" class="loading-message">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="no-results" id="no-results" style="display: none;">
                <div class="no-results-icon">ğŸ“‹</div>
                <h3>å°šç„¡å•å·çµæœ</h3>
                <p>ç•¶ä½¿ç”¨è€…å®Œæˆè¡›æ•™å½±ç‰‡è§€çœ‹ä¸¦æäº¤å•å·å¾Œï¼Œçµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</p>
            </div>

            <!-- Email è¨­å®šå½ˆçª— -->
            <div id="email-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>è¨­å®šé€šçŸ¥ Email</h3>
                    <div id="email-list">
                        <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                        <div class="loading-indicator">
                            <div class="spinner small"></div>
                            <span>è¼‰å…¥ Email è¨­å®š...</span>
                        </div>
                    </div>
                    <div class="email-form">
                        <input type="email" id="new-email" placeholder="æ–°å¢ Email">
                        <button id="add-email">æ–°å¢</button>
                    </div>
                    <div class="form-help">
                        <p>æ–°å•å·çµæœæäº¤æ™‚ï¼Œç³»çµ±å°‡ç™¼é€é€šçŸ¥è‡³å·²å•Ÿç”¨çš„ Email åœ°å€ã€‚</p>
                    </div>
                    <div class="form-buttons">
                        <button id="cancel-email-settings" class="secondary-button">å–æ¶ˆ</button>
                        <button id="save-emails" class="primary-button">å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 è¡›æ•™å½±ç‰‡è§€çœ‹ç³»çµ±</p>
    </footer>
    
    <!-- ä¿®æ­£é †åºï¼šå…ˆåŠ è¼‰èªè­‰å’Œå­˜å„²è…³æœ¬ -->
    <script src="js/github-auth.js"></script>
    <script src="js/github-storage.js"></script>
    
    <!-- å†åŠ è¼‰é é¢ç‰¹å®šè…³æœ¬ -->
    <script src="js/results.js"></script>
    
    <script>
        // é é¢åŠ è¼‰å®Œæˆå¾Œéš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const loader = document.getElementById('page-loader');
                if (loader) {
                    loader.classList.add('hidden');
                    setTimeout(function() {
                        loader.remove();
                    }, 300);
                }
            }, 500);
            
            // ä¿®æ­£ Email è¨­å®šæ¨¡æ…‹æ¡†äº‹ä»¶
            const emailSettingsButton = document.getElementById('email-settings-button');
            const emailModal = document.getElementById('email-modal');
            const closeBtn = emailModal?.querySelector('.close');
            const cancelBtn = document.getElementById('cancel-email-settings');
            
            if (emailSettingsButton && emailModal) {
                emailSettingsButton.addEventListener('click', function() {
                    emailModal.style.display = 'block';
                    
                    // å¦‚æœæœ‰ loadEmailList å‡½æ•¸ï¼Œèª¿ç”¨å®ƒ
                    if (typeof loadEmailList === 'function') {
                        loadEmailList();
                    }
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    emailModal.style.display = 'none';
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    emailModal.style.display = 'none';
                });
            }
            
            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            window.addEventListener('click', function(event) {
                if (event.target === emailModal) {
                    emailModal.style.display = 'none';
                }
            });
        });
        
        // æ·»åŠ å…¨å±€éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€éŒ¯èª¤:', event.message, event.filename, event.lineno);
            
            // é¡¯ç¤ºå‹å¥½éŒ¯èª¤è¨Šæ¯
            const systemMessages = document.getElementById('system-messages');
            if (systemMessages) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.innerHTML = `
                    <strong>ç™¼ç”ŸéŒ¯èª¤:</strong> 
                    ç³»çµ±é‹è¡Œæ™‚é‡åˆ°å•é¡Œã€‚å¦‚æœå•é¡ŒæŒçºŒå­˜åœ¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚
                    <button onclick="this.parentNode.remove();" class="close-message">é—œé–‰</button>
                `;
                systemMessages.appendChild(errorMsg);
                
                // åœæ­¢è‡ªå‹•åˆ·æ–°è¨ˆæ™‚å™¨
                if (typeof stopCountdown === 'function') {
                    stopCountdown();
                }
            }
            
            // å¦‚æœè¡¨æ ¼æ­£åœ¨è¼‰å…¥ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            const resultsBody = document.getElementById('results-body');
            if (resultsBody && resultsBody.querySelector('.loading-message')) {
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="error-message">
                            è¼‰å…¥çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹å˜—è©¦
                            <button onclick="location.reload();" class="reload-button">é‡æ–°è¼‰å…¥é é¢</button>
                        </td>
                    </tr>
                `;
            }
        });
        
        // æä¾›åˆ·æ–°å€’æ•¸è¨ˆæ™‚å™¨åœæ­¢åŠŸèƒ½
        function stopCountdown() {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = 'å·²åœæ­¢';
                    countdownElement.style.color = '#e74c3c';
                }
            }
        }
    </script>
</body>
</html>
