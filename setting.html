<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>åºŠè™Ÿè¡›æ•™è¨­å®š</title>
    <!-- è¼‰å…¥ç¾æœ‰ç³»çµ±çš„ CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <!-- é åŠ è¼‰é—œéµè³‡æº -->
    <link rel="preload" href="js/github-auth.js" as="script">
    <link rel="preload" href="js/github-storage.js" as="script">
    <style>
        /* åºŠè™Ÿè¨­å®šé é¢ç‰¹å®šæ¨£å¼ */
        .topic-selection {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .topic-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 1rem;
            background-color: white;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .topic-card.selected {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }
        
        .topic-card.selected:before {
            content: "âœ“";
            position: absolute;
            top: 5px;
            right: 10px;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .topic-id {
            font-weight: bold;
            margin-right: 0.5rem;
            color: #495057;
        }
        
        .topic-name {
            font-size: 1rem;
            color: #212529;
            word-break: break-word;
        }
        
        .selection-summary {
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #e8f5e9;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bed-config {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .primary-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .primary-button:hover {
            background-color: #0069d9;
        }
        
        .primary-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .secondary-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .secondary-button:hover {
            background-color: #5a6268;
        }
        
        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .delete-button:hover {
            background-color: #c82333;
        }
        
        .edit-button {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .edit-button:hover {
            background-color: #138496;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 1rem;
        }
        
        .topic-chip {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #e9ecef;
            border-radius: 16px;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .loader-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .system-messages {
            margin-bottom: 1rem;
        }
        
        .error-message, .success-message {
            padding: 0.75rem;
            border-radius: 3px;
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .close-message {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
        }
        
        .close-message:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- é é¢åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="page-loader" class="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <header>
        <h1>è¡›æ•™å½±ç‰‡è§€çœ‹ç³»çµ±</h1>
        <nav>
            <ul>
                <li><a href="index.html">å½±ç‰‡è§€çœ‹</a></li>
                <li><a href="results.html">çµæœåˆ—è¡¨</a></li>
                <li><a href="admin.html">ç®¡ç†è¨­å®š</a></li>
                <li><a href="setting.html" class="active">åºŠè™Ÿè¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- ç³»çµ±è¨Šæ¯å€åŸŸ -->
        <div id="system-messages" class="system-messages">
            <!-- éŒ¯èª¤å’Œç‹€æ…‹æ¶ˆæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- GitHub é€£æ¥ç‹€æ…‹å€å¡Š -->
        <section id="github-status">
            <div class="status-container">
                <div id="connection-status" class="status-indicator">
                    <span class="status-icon">âš«</span>
                    <span class="status-text">æª¢æŸ¥é€£æ¥ä¸­...</span>
                </div>
                <div class="status-actions">
                    <button id="check-connection">é‡æ–°æª¢æŸ¥é€£æ¥</button>
                </div>
            </div>
        </section>

        <!-- ä¸»é¡Œé¸æ“‡å€å¡Š -->
        <section class="topic-selection">
            <h2>é¸æ“‡è¡›æ•™ä¸»é¡Œ</h2>
            <p>å¾ä¸‹æ–¹é¸æ“‡è¦åŒ…å«åœ¨é¡Œçµ„ä¸­çš„è¡›æ•™ä¸»é¡Œ</p>
            
            <div class="topic-grid" id="topic-grid">
                <p class="loading-message">
                    <span class="loader-spinner"></span>
                    è¼‰å…¥ä¸»é¡Œä¸­...
                </p>
            </div>
            
            <div class="selection-summary">
                <span id="selected-count">å·²é¸æ“‡: <strong>0</strong> å€‹ä¸»é¡Œ</span>
                <button id="reset-selection" class="secondary-button" disabled>é‡ç½®é¸æ“‡</button>
            </div>
        </section>

        <!-- åºŠè™Ÿé…ç½®å€å¡Š -->
        <section class="bed-config">
            <h2>åºŠè™Ÿè¡›æ•™é¡Œçµ„é…ç½®</h2>
            <p>è¨­å®šç‰¹å®šåºŠè™Ÿå°æ‡‰çš„è¡›æ•™ä¸»é¡Œ</p>
            
            <form id="bed-config-form">
                <div class="form-group">
                    <label for="bed-number">åºŠè™Ÿ</label>
                    <input type="text" id="bed-number" placeholder="è¼¸å…¥åºŠè™Ÿï¼ˆå¦‚ï¼š7011ï¼‰" required>
                </div>
                
                <div class="form-group">
                    <label for="group-name">é¡Œçµ„åç¨±</label>
                    <input type="text" id="group-name" placeholder="è¼¸å…¥é¡Œçµ„åç¨±ï¼ˆå¦‚ï¼šè¡“å¾Œè¡›æ•™ï¼‰" required>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" id="save-config" class="primary-button" disabled>å„²å­˜é…ç½®</button>
                    <button type="button" id="cancel-edit" class="secondary-button" style="display: none;">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </form>
        </section>

        <!-- å·²é…ç½®åºŠè™Ÿå€å¡Š -->
        <section class="configured-beds">
            <h2>å·²é…ç½®åºŠè™Ÿ</h2>
            
            <table id="bed-table">
                <thead>
                    <tr>
                        <th>åºŠè™Ÿ</th>
                        <th>é¡Œçµ„åç¨±</th>
                        <th>åŒ…å«ä¸»é¡Œ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bed-table-body">
                    <!-- é è¨­é¡¯ç¤ºç„¡æ•¸æ“šè¨Šæ¯ -->
                    <tr>
                        <td colspan="4" class="no-data">å°šæœªé…ç½®ä»»ä½•åºŠè™Ÿé¡Œçµ„</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 è¡›æ•™å½±ç‰‡è§€çœ‹ç³»çµ±</p>
    </footer>

    <!-- å…ˆåŠ è¼‰èªè­‰å’Œå­˜å„²è…³æœ¬ -->
    <script src="js/github-auth.js"></script>
    <script src="js/github-storage.js"></script>
    
    <!-- åºŠè™Ÿè¨­å®šé é¢ç‰¹å®šè…³æœ¬ -->
    <script>
        // å…¨å±€è®Šæ•¸
        let topics = []; // å­˜å„²æ‰€æœ‰ä¸»é¡Œ
        let bedConfigurations = []; // å­˜å„²æ‰€æœ‰åºŠè™Ÿé…ç½®
        let selectedTopics = []; // å­˜å„²å·²é¸ä¸­çš„ä¸»é¡Œ ID
        let currentEditingBed = null; // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„åºŠè™Ÿç´¢å¼•
        
        // é é¢åŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            setTimeout(function() {
                const loader = document.getElementById('page-loader');
                if (loader) {
                    loader.classList.add('hidden');
                    setTimeout(function() {
                        loader.remove();
                    }, 300);
                }
            }, 500);
            
            // åˆå§‹åŒ–é é¢
            await initPage();
            
            // è¨»å†Šäº‹ä»¶è™•ç†å™¨
            document.getElementById('reset-selection').addEventListener('click', resetSelection);
            document.getElementById('bed-config-form').addEventListener('submit', saveBedConfiguration);
            document.getElementById('cancel-edit').addEventListener('click', cancelEditing);
            document.getElementById('check-connection').addEventListener('click', checkGitHubConnection);
        });
        
        // åˆå§‹åŒ–é é¢
        async function initPage() {
            try {
                // æª¢æŸ¥ GitHub é€£æ¥
                await checkGitHubConnection();
                
                // åŠ è¼‰ä¸»é¡Œæ•¸æ“š
                await loadTopics();
                
                // åŠ è¼‰åºŠè™Ÿé…ç½®
                await loadBedConfigurations();
            } catch (error) {
                showError('åˆå§‹åŒ–é é¢æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('åˆå§‹åŒ–é é¢éŒ¯èª¤:', error);
            }
        }
        
        // æª¢æŸ¥ GitHub é€£æ¥
        async function checkGitHubConnection() {
            const statusIcon = document.querySelector('#connection-status .status-icon');
            const statusText = document.querySelector('#connection-status .status-text');
            
            statusIcon.textContent = 'âš«';
            statusText.textContent = 'æª¢æŸ¥é€£æ¥ä¸­...';
            
            try {
                // å‡è¨­ GitHub å­˜å„²è…³æœ¬ä¸­æœ‰ checkGitHubConnection å‡½æ•¸
                const result = await window.checkGitHubConnection();
                
                if (result.connected) {
                    statusIcon.textContent = 'ğŸŸ¢';
                    statusIcon.style.color = '#28a745';
                    statusText.textContent = 'å·²é€£æ¥åˆ° GitHub å„²å­˜åº«';
                } else {
                    statusIcon.textContent = 'ğŸ”´';
                    statusIcon.style.color = '#dc3545';
                    statusText.textContent = 'ç„¡æ³•é€£æ¥åˆ° GitHub: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                statusIcon.textContent = 'ğŸ”´';
                statusIcon.style.color = '#dc3545';
                statusText.textContent = 'æª¢æŸ¥é€£æ¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message;
                console.error('æª¢æŸ¥ GitHub é€£æ¥éŒ¯èª¤:', error);
            }
        }
        
        // åŠ è¼‰ä¸»é¡Œæ•¸æ“š
        async function loadTopics() {
            const topicGrid = document.getElementById('topic-grid');
            topicGrid.innerHTML = '<p class="loading-message"><span class="loader-spinner"></span>è¼‰å…¥ä¸»é¡Œä¸­...</p>';
            
            try {
                // å¾ GitHub è®€å–ä¸»é¡Œæ•¸æ“š
                const data = await window.readGitHubFile('topics.json');
                topics = JSON.parse(data);
                
                // æ¸²æŸ“ä¸»é¡Œå¡ç‰‡
                renderTopics();
            } catch (error) {
                topicGrid.innerHTML = '<p class="error-message">è¼‰å…¥ä¸»é¡Œå¤±æ•—: ' + error.message + '</p>';
                console.error('è¼‰å…¥ä¸»é¡ŒéŒ¯èª¤:', error);
            }
        }
        
        // æ¸²æŸ“ä¸»é¡Œå¡ç‰‡
        function renderTopics() {
            const topicGrid = document.getElementById('topic-grid');
            
            if (topics.length === 0) {
                topicGrid.innerHTML = '<p class="no-data">æ²’æœ‰å¯ç”¨çš„ä¸»é¡Œ</p>';
                return;
            }
            
            topicGrid.innerHTML = '';
            
            // æŒ‰ç…§ ID æ’åºä¸»é¡Œ
            topics.sort((a, b) => parseInt(a.id) - parseInt(b.id));
            
            // å‰µå»ºä¸»é¡Œå¡ç‰‡
            topics.forEach(topic => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.dataset.id = topic.id;
                
                if (selectedTopics.includes(topic.id)) {
                    card.classList.add('selected');
                }
                
                card.innerHTML = `
                    <span class="topic-id">#${topic.id}</span>
                    <span class="topic-name">${topic.name}</span>
                `;
                
                card.addEventListener('click', () => toggleTopicSelection(topic.id));
                
                topicGrid.appendChild(card);
            });
        }
        
        // åˆ‡æ›ä¸»é¡Œé¸æ“‡ç‹€æ…‹
        function toggleTopicSelection(topicId) {
            const index = selectedTopics.indexOf(topicId);
            
            if (index === -1) {
                // é¸ä¸­ä¸»é¡Œ
                selectedTopics.push(topicId);
            } else {
                // å–æ¶ˆé¸ä¸­
                selectedTopics.splice(index, 1);
            }
            
            // æ›´æ–° UI
            updateSelectionUI();
            updateSaveButtonState();
        }
        
        // æ›´æ–°é¸æ“‡ UI
        function updateSelectionUI() {
            // æ›´æ–°å·²é¸æ“‡æ•¸é‡
            document.querySelector('#selected-count strong').textContent = selectedTopics.length;
            
            // æ›´æ–°é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('reset-selection').disabled = selectedTopics.length === 0;
            
            // æ›´æ–°ä¸»é¡Œå¡ç‰‡æ¨£å¼
            const cards = document.querySelectorAll('.topic-card');
            cards.forEach(card => {
                const topicId = card.dataset.id;
                if (selectedTopics.includes(topicId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        
        // é‡ç½®é¸æ“‡
        function resetSelection() {
            selectedTopics = [];
            updateSelectionUI();
            updateSaveButtonState();
        }
        
        // æ›´æ–°ä¿å­˜æŒ‰éˆ•ç‹€æ…‹
        function updateSaveButtonState() {
            const bedNumber = document.getElementById('bed-number').value.trim();
            const groupName = document.getElementById('group-name').value.trim();
            
            document.getElementById('save-config').disabled = 
                selectedTopics.length === 0 || !bedNumber || !groupName;
        }
        
        // åŠ è¼‰åºŠè™Ÿé…ç½®
        async function loadBedConfigurations() {
            try {
                // å˜—è©¦å¾ GitHub è®€å–åºŠè™Ÿé…ç½®
                try {
                    const data = await window.readGitHubFile('bed_configurations.json');
                    bedConfigurations = JSON.parse(data);
                } catch (error) {
                    // æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºæ•¸çµ„
                    bedConfigurations = [];
                }
                
                // æ¸²æŸ“åºŠè™Ÿé…ç½®è¡¨æ ¼
                renderBedConfigurations();
            } catch (error) {
                showError('è¼‰å…¥åºŠè™Ÿé…ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('è¼‰å…¥åºŠè™Ÿé…ç½®éŒ¯èª¤:', error);
            }
        }
        
        // æ¸²æŸ“åºŠè™Ÿé…ç½®è¡¨æ ¼
        function renderBedConfigurations() {
            const tableBody = document.getElementById('bed-table-body');
            
            if (bedConfigurations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="no-data">å°šæœªé…ç½®ä»»ä½•åºŠè™Ÿé¡Œçµ„</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            bedConfigurations.forEach((config, index) => {
                const tr = document.createElement('tr');
                
                // å‰µå»ºä¸»é¡ŒèŠ¯ç‰‡ HTML
                const topicChips = config.topics.map(topicId => {
                    const topic = topics.find(t => t.id === topicId);
                    return `<span class="topic-chip">#${topicId}${topic ? ': ' + topic.name : ''}</span>`;
                }).join('');
                
                tr.innerHTML = `
                    <td>${config.bedNumber}</td>
                    <td>${config.groupName}</td>
                    <td>${topicChips}</td>
                    <td class="action-buttons">
                        <button class="edit-button" onclick="editBedConfiguration(${index})">ç·¨è¼¯</button>
                        <button class="delete-button" onclick="deleteBedConfiguration(${index})">åˆªé™¤</button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
        }
        
        // ä¿å­˜åºŠè™Ÿé…ç½®
        async function saveBedConfiguration(event) {
            event.preventDefault();
            
            const bedNumber = document.getElementById('bed-number').value.trim();
            const groupName = document.getElementById('group-name').value.trim();
            
            if (!bedNumber || !groupName || selectedTopics.length === 0) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½ä¸¦é¸æ“‡è‡³å°‘ä¸€å€‹ä¸»é¡Œ');
                return;
            }
            
            try {
                const newConfig = {
                    bedNumber,
                    groupName,
                    topics: [...selectedTopics]
                };
                
                if (currentEditingBed !== null) {
                    // æ›´æ–°ç¾æœ‰é…ç½®
                    bedConfigurations[currentEditingBed] = newConfig;
                } else {
                    // æª¢æŸ¥åºŠè™Ÿæ˜¯å¦å·²ç¶“å­˜åœ¨
                    const existingIndex = bedConfigurations.findIndex(c => c.bedNumber === bedNumber);
                    
                    if (existingIndex !== -1) {
                        // ç¢ºèªæ˜¯å¦è¦†è“‹
                        if (!confirm(`åºŠè™Ÿ ${bedNumber} å·²å­˜åœ¨é…ç½®ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`)) {
                            return;
                        }
                        
                        // è¦†è“‹ç¾æœ‰é…ç½®
                        bedConfigurations[existingIndex] = newConfig;
                    } else {
                        // æ·»åŠ æ–°é…ç½®
                        bedConfigurations.push(newConfig);
                    }
                }
                
                // ä¿å­˜åˆ° GitHub
                await window.writeGitHubFile('bed_configurations.json', JSON.stringify(bedConfigurations, null, 2));
                
                // é‡æ–°æ¸²æŸ“åºŠè™Ÿé…ç½®è¡¨æ ¼
                renderBedConfigurations();
                
                // é‡ç½®è¡¨å–®
                resetForm();
                
                showSuccess('åºŠè™Ÿé…ç½®å·²ä¿å­˜');
            } catch (error) {
                showError('ä¿å­˜åºŠè™Ÿé…ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('ä¿å­˜åºŠè™Ÿé…ç½®éŒ¯èª¤:', error);
            }
        }
        
        // ç·¨è¼¯åºŠè™Ÿé…ç½®
        function editBedConfiguration(index) {
            const config = bedConfigurations[index];
            
            // è¨­ç½®è¡¨å–®å€¼
            document.getElementById('bed-number').value = config.bedNumber;
            document.getElementById('group-name').value = config.groupName;
            
            // è¨­ç½®é¸ä¸­çš„ä¸»é¡Œ
            selectedTopics = [...config.topics];
            updateSelectionUI();
            
            // é¡¯ç¤ºå–æ¶ˆç·¨è¼¯æŒ‰éˆ•
            document.getElementById('cancel-edit').style.display = 'block';
            
            // æ›´æ–°ä¿å­˜æŒ‰éˆ•æ–‡å­—
            document.getElementById('save-config').textContent = 'æ›´æ–°é…ç½®';
            document.getElementById('save-config').disabled = false;
            
            // è¨­ç½®ç•¶å‰ç·¨è¼¯ç´¢å¼•
            currentEditingBed = index;
            
            // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
            document.querySelector('.bed-config').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆªé™¤åºŠè™Ÿé…ç½®
        async function deleteBedConfiguration(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åºŠè™Ÿé…ç½®å—ï¼Ÿ')) {
                return;
            }
            
            try {
                // å¾æ•¸çµ„ä¸­ç§»é™¤é…ç½®
                bedConfigurations.splice(index, 1);
                
                // ä¿å­˜åˆ° GitHub
                await window.writeGitHubFile('bed_configurations.json', JSON.stringify(bedConfigurations, null, 2));
                
                // é‡æ–°æ¸²æŸ“åºŠè™Ÿé…ç½®è¡¨æ ¼
                renderBedConfigurations();
                
                // å¦‚æœæ­£åœ¨ç·¨è¼¯è¢«åˆªé™¤çš„é …ç›®ï¼Œé‡ç½®è¡¨å–®
                if (currentEditingBed === index) {
                    resetForm();
                } else if (currentEditingBed > index) {
                    // èª¿æ•´ç•¶å‰ç·¨è¼¯ç´¢å¼•
                    currentEditingBed--;
                }
                
                showSuccess('åºŠè™Ÿé…ç½®å·²åˆªé™¤');
            } catch (error) {
                showError('åˆªé™¤åºŠè™Ÿé…ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('åˆªé™¤åºŠè™Ÿé…ç½®éŒ¯èª¤:', error);
            }
        }
        
        // å–æ¶ˆç·¨è¼¯
        function cancelEditing() {
            resetForm();
            showSuccess('å·²å–æ¶ˆç·¨è¼¯');
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('bed-config-form').reset();
            resetSelection();
            
            // éš±è—å–æ¶ˆç·¨è¼¯æŒ‰éˆ•
            document.getElementById('cancel-edit').style.display = 'none';
            
            // é‡ç½®ä¿å­˜æŒ‰éˆ•æ–‡å­—
            document.getElementById('save-config').textContent = 'å„²å­˜é…ç½®';
            document.getElementById('save-config').disabled = true;
            
            // é‡ç½®ç•¶å‰ç·¨è¼¯ç´¢å¼•
            currentEditingBed = null;
        }
        
        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const systemMessages = document.getElementById('system-messages');
            
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.innerHTML = `
                <strong>éŒ¯èª¤:</strong> ${message}
                <button onclick="this.parentNode.remove();" class="close-message">é—œé–‰</button>
            `;
            
            systemMessages.appendChild(errorMsg);
            
            // 5 ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                errorMsg.remove();
            }, 5000);
        }
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
            const systemMessages = document.getElementById('system-messages');
            
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.innerHTML = `
                <strong>æˆåŠŸ:</strong> ${message}
                <button onclick="this.parentNode.remove();" class="close-message">é—œé–‰</button>
            `;
            
            systemMessages.appendChild(successMsg);
            
            // 3 ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
        
        // ç›£è½è¡¨å–®è¼¸å…¥è®ŠåŒ–
        document.getElementById('bed-number').addEventListener('input', updateSaveButtonState);
        document.getElementById('group-name').addEventListener('input', updateSaveButtonState);
        
        // æ·»åŠ å…¨å±€éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€éŒ¯èª¤:', event.message, event.filename, event.lineno);
            
            showError('ç³»çµ±é‹è¡Œæ™‚é‡åˆ°å•é¡Œ: ' + event.message);
        });
    </script>
</body>
</html>
